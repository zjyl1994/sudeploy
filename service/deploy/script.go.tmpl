#!/bin/bash
set -e
echo "[$(date +"%Y-%m-%d %H:%M:%S")] Deploying {{.Name}} on $(hostname -f)"
{{if .Install}}
systemctl daemon-reload
{{end}}
{{if .Running}}
systemctl stop {{.Name}}
{{end}}
mv {{.BinSrc}} {{.BinDst}}
chmod +x {{.BinDst}}
systemctl start {{.Name}}

{{if .WaitSeconds}}
echo "[$(date +"%Y-%m-%d %H:%M:%S")] Wait {{.Name}} start...(Timeout: {{.WaitSeconds}})"
sleep {{.WaitSeconds}}
{{end}}
systemctl --no-pager status {{.Name}}

{{if .Install}}
systemctl enable {{.Name}}
{{end}}

rm -rf {{.BinSrc}}
rm -rf $0

echo "[$(date +"%Y-%m-%d %H:%M:%S")] Deploy OK!"